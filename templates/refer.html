{% extends 'base.html' %}

{% block title %}Refer & Earn{% endblock %}

{% block content %}
<section class="page-hero">
    <div class="page-hero-bg">
        <div class="gfg-orb orb-1"></div>
        <div class="gfg-orb orb-2"></div>
        <div class="grid-pattern"></div>
    </div>
    <div class="container hero-container">
        <div class="breadcrumb reveal-up">
            <a href="{{ url_for('home') }}">Home</a>
            <i data-lucide="chevron-right"></i>
            <span>Refer & Earn</span>
        </div>
        <div class="hero-content-split">
            <div class="hero-text-side">
                <h1 class="page-title reveal-up">Spread the <span class="highlight text-gradient">Knowledge</span></h1>
                <p class="page-subtitle reveal-up">Invite your friends to the GFG IEC Chapter and unlock exclusive
                    rewards together. More friends = More points!</p>
                <div class="hero-actions reveal-up">
                    <a href="#referral-section" class="btn-glow">Get Started <i data-lucide="arrow-down"></i></a>
                </div>
            </div>
            <div class="hero-visual-side reveal-up">
                <div class="premium-stats-preview">
                    <div class="preview-card">
                        <div class="preview-icon"><i data-lucide="users"></i></div>
                        <div class="preview-info">
                            <span class="preview-label">Community Growth</span>
                            <span class="preview-value">+150 This Week</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section-block" id="referral-section">
    <div class="container">
        <div class="referral-main-grid">
            <!-- Referral Code Card -->
            <div class="referral-card-container">
                <div class="referral-code-card glass-card reveal-item">
                    <div class="referral-header">
                        <div class="referral-icon">
                            <i data-lucide="gift"></i>
                        </div>
                        <div class="referral-title-section">
                            <h2>Your Referral Code</h2>
                            <p>Share this unique code to start earning points</p>
                        </div>
                    </div>

                    <div class="referral-code-wrapper">
                        <div class="code-box-premium" id="code-box">
                            <span class="code-text" id="referral-code-text">Loading...</span>
                            <div class="code-copy-overlay">
                                <button class="copy-icon-btn" id="copy-code-btn" title="Copy Code">
                                    <i data-lucide="copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="referral-actions-grid">
                        <button class="btn-primary share-btn" id="share-link-btn">
                            <i data-lucide="share-2"></i>
                            <span>Share Link</span>
                        </button>
                        <div class="social-share-hints">
                            <i data-lucide="zap"></i>
                            <span>Instant +5 points per join</span>
                        </div>
                    </div>

                    <div class="referral-stats-premium">
                        <div class="stat-pill">
                            <div class="pill-icon"><i data-lucide="users"></i></div>
                            <div class="pill-content">
                                <span class="pill-value" id="referral-count">0</span>
                                <span class="pill-label">Referred</span>
                            </div>
                        </div>
                        <div class="stat-pill highlight">
                            <div class="pill-icon"><i data-lucide="award"></i></div>
                            <div class="pill-content">
                                <span class="pill-value" id="points-earned">0</span>
                                <span class="pill-label">Earned</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Use Referral Code Card -->
            <div class="redeem-card-container">
                <div class="use-referral-card glass-card reveal-item">
                    <div class="card-badge">Limited Time</div>
                    <h3>Redeem Code</h3>
                    <p>Enter a friend's code to claim your +5 points bonus instantly.</p>

                    <form id="use-referral-form" class="premium-form">
                        <div class="input-wrapper">
                            <i data-lucide="ticket" class="input-icon"></i>
                            <input type="text" id="referral-code-input" placeholder="Enter Code Here" autocomplete="off"
                                maxlength="8">
                        </div>
                        <button type="submit" class="btn-glow full-width">
                            <span>Claim Bonus Points</span>
                            <i data-lucide="arrow-right"></i>
                        </button>
                    </form>

                    <div class="referral-status" id="referral-status"></div>

                    <div class="form-footer-hint">
                        <i data-lucide="info"></i>
                        One-time bonus for new members
                    </div>
                </div>
            </div>
        </div>

        <!-- How it Works Modern -->
        <div class="how-it-works-section reveal-up">
            <div class="section-title-centered">
                <span class="section-tag">Simple Process</span>
                <h2>How It <span class="highlight">Works</span></h2>
            </div>

            <div class="modern-steps-grid">
                <div class="modern-step-card">
                    <div class="step-visual">
                        <div class="step-num">01</div>
                        <div class="step-icon-bg"><i data-lucide="send"></i></div>
                    </div>
                    <h4>Share Invite</h4>
                    <p>Send your unique referral code or link to your friends.</p>
                </div>

                <div class="step-connector"><i data-lucide="chevron-right"></i></div>

                <div class="modern-step-card">
                    <div class="step-visual">
                        <div class="step-num">02</div>
                        <div class="step-icon-bg"><i data-lucide="user-plus"></i></div>
                    </div>
                    <h4>Friend Joins</h4>
                    <p>They sign up and enter your code in their profile.</p>
                </div>

                <div class="step-connector"><i data-lucide="chevron-right"></i></div>

                <div class="modern-step-card highlight">
                    <div class="step-visual">
                        <div class="step-num">03</div>
                        <div class="step-icon-bg"><i data-lucide="gift"></i></div>
                    </div>
                    <h4>Both Gain</h4>
                    <p>You and your friend both receive +5 bonus points!</p>
                </div>
            </div>
        </div>

        <!-- Referrals List Modern -->
        <div class="referrals-list-container reveal-up" id="referrals-list-section" style="display: none;">
            <div class="list-header">
                <h3>Success Stories</h3>
                <span class="list-count" id="list-count-badge">0 Friends</span>
            </div>
            <div class="premium-table-wrapper">
                <table class="premium-table">
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Date Joined</th>
                            <th>Reward</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="referrals-tbody">
                        <!-- Loaded via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<script>
    // Referral System JavaScript
    let currentUsername = localStorage.getItem('gfg_handle') || null;

    document.addEventListener('DOMContentLoaded', () => {
        if (currentUsername) {
            loadReferralData();
        } else {
            document.getElementById('referral-code-text').textContent = 'Please set your GFG handle first';
            document.getElementById('copy-code-btn').disabled = true;
        }

        // Copy code button
        document.getElementById('copy-code-btn')?.addEventListener('click', copyReferralCode);

        // Share link button
        document.getElementById('share-link-btn')?.addEventListener('click', shareReferralLink);

        // Use referral form
        document.getElementById('use-referral-form')?.addEventListener('submit', useReferralCode);
    });

    async function loadReferralData() {
        try {
            const response = await fetch(`/api/referral/stats/${currentUsername}`);
            const data = await response.json();

            if (data.success) {
                document.getElementById('referral-code-text').textContent = data.referral_code || 'Generating...';
                document.getElementById('referral-count').textContent = data.referral_count || 0;
                document.getElementById('points-earned').textContent = (data.referral_count || 0) * 5;

                const listCountBadge = document.getElementById('list-count-badge');
                if (listCountBadge) {
                    listCountBadge.textContent = `${data.referral_count || 0} Friends`;
                }

                if (data.referrals_made && data.referrals_made.length > 0) {
                    displayReferrals(data.referrals_made);
                }

                // If user was referred, hide the use referral section or show success
                if (data.was_referred_by) {
                    const redeemCard = document.querySelector('.use-referral-card');
                    if (redeemCard) {
                        redeemCard.innerHTML = `
                            <div class="success-message-premium">
                                <div class="success-icon">
                                    <i data-lucide="check-circle"></i>
                                </div>
                                <h3>Bonus Claimed!</h3>
                                <p>You were referred by <strong>${data.was_referred_by}</strong></p>
                                <div class="points-badge-success">+5 Points Applied</div>
                            </div>
                        `;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            }
        } catch (error) {
            console.error('Error loading referral data:', error);
        }
    }

    function copyReferralCode() {
        const codeText = document.getElementById('referral-code-text').textContent;
        navigator.clipboard.writeText(codeText).then(() => {
            showToast('Referral code copied!');
        });
    }

    function shareReferralLink() {
        const code = document.getElementById('referral-code-text').textContent;
        if (!code || code === 'Loading...' || code.includes('Please')) return;

        const shareUrl = `${window.location.origin}/?refer=${code}`;
        const shareData = {
            title: 'Join GFG IEC Chapter',
            text: `Use my referral code ${code} to join the GFG IEC Student Chapter and earn bonus points!`,
            url: shareUrl
        };

        if (navigator.share) {
            navigator.share(shareData).catch(console.error);
        } else {
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Referral link copied to clipboard!');
            });
        }
    }

    async function useReferralCode(e) {
        e.preventDefault();

        if (!currentUsername) {
            showToast('Please set your GFG handle first');
            return;
        }

        const code = document.getElementById('referral-code-input').value.trim().toUpperCase();

        if (!code) {
            showToast('Please enter a referral code');
            return;
        }

        try {
            const response = await fetch('/api/referral/use', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUsername, code: code })
            });

            const data = await response.json();

            if (data.success) {
                showToast('✅ Referral code applied! +5 points added');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast('❌ ' + (data.error || 'Invalid code'));
            }
        } catch (error) {
            showToast('Error applying code');
            console.error(error);
        }
    }

    function displayReferrals(referrals) {
        const listSection = document.getElementById('referrals-list-section');
        const tbody = document.getElementById('referrals-tbody');

        if (!listSection || !tbody) return;

        listSection.style.display = 'block';

        tbody.innerHTML = referrals.map((ref, index) => `
            <tr class="reveal-item">
                <td>
                    <div class="member-info">
                        <div class="member-avatar">${ref.new_user.charAt(0).toUpperCase()}</div>
                        <span>${ref.new_user}</span>
                    </div>
                </td>
                <td>${new Date(ref.created_at).toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                <td><span class="points-pill">+5 Points</span></td>
                <td><span class="status-pill-success">Completed</span></td>
            </tr>
        `).join('');

        // Re-initialize animations if possible
        if (typeof initRevealAnimations === 'function') initRevealAnimations();
    }

    function showToast(message) {
        // Reuse existing toast function from main.js
        if (typeof window.showToast === 'function') {
            window.showToast(message);
        } else {
            alert(message);
        }
    }
</script>
{% endblock %}